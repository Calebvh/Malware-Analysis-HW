#include <stdio.h>
#include <string.h>

/*void obfuscate(int param_1,uint param_2)

{
  uint local_c;
  uint local_8;
  
  local_c = 0x1f2f3f4f;
  if (param_2 < 0x101) {
    local_8 = 0;
    while (local_8 < param_2) {
      local_c = (int)*(char *)(param_1 + local_8) * (local_c >> 3) * (local_8 + 1);
      *(undefined *)(param_1 + local_8) = (char)local_c;
      local_8 = local_8 + 1;
    }
  }
  return;
}*/
void obfuscate(char* flag, int flag_len){
  unsigned int local_c = 523190095;
  for(int i = 0; i<flag_len; i++){
    local_c = flag[i] * (local_c >>3) * (i+1);    
    flag[i] = local_c;
  }
}

int findIndex(char* str, char tofind){
  char* ptr;
  int index;
  ptr = strchr(str, tofind);
  if(ptr==NULL){
    printf("Character not found");
    return 0;
  }
  index = ptr - str;
  return index;
}

//                    1     2     3     4     5     6     7     8     9     10   11    12    13
char checker[37] = {0xD6, 0xF0, 0xBA, 0x04, 0x40, 0x90, 0x32, 0x30, 0x18, 0x18, 0xC3, 0x80, 0x80,
                    0xE0, 0xD8, 0x20, 0x2C, 0x02, 0xA0, 0x20, 0x2C, 0x7C, 0x49, 0xB8, 0xD0, 0xE0, 
                    0x7C, 0x98, 0x6C, 0x56, 0x84, 0x00, 0x00, 0x00, 0x80, 0xC0, 0x00 };

char charBank[17] = {'a', 'b', 'c', 'd', 'e', 'f','}',
'0','1','2','3','4','5','6','7','8','9'};

void main(int argc, char const *argv[])
{
  char flag[35] = {'f', 'l', 'a', 'g','{'};
  char flag_temp[35];
  int flag_end = 5;
  int helper;
  int prev_char = -1;
  int count = 0;

  while(flag_end < 35){
    helper = flag_end;
    int i = 0;
    printf("Flag end: %i\n", flag_end);
    for(i; i<17; i++){
      memset(flag_temp,0, 35);
      strncpy(flag_temp,flag,flag_end);
      flag_temp[flag_end] = charBank[i];
      
      printf("Len: %li  Char: %s --:", strlen(flag_temp), flag_temp);
      
      obfuscate(flag_temp, strlen(flag_temp));

      printf("New char: %02x -> %02x\n", flag_temp[flag_end], checker[flag_end]);

      if(flag_temp[flag_end] == checker[flag_end] && prev_char<i){
        printf("Found a character: %c", charBank[i]);
        
        if(flag_end < 34 || flag_end == 34 && charBank[i] == '}'){
          printf("\n");
          prev_char = -1;
          flag[flag_end] = charBank[i];
          flag_end++;
          break;
        }
        else{
          printf("--- Not going this route \n");
        }
      }
    }
    if(flag_end == helper){
      printf("Wrong character found: going back...\n");
      prev_char = findIndex(charBank, flag[flag_end-1]);
      flag[flag_end-1] = 0;
      flag_end= flag_end-1;

      printf("prev char: %c\n", charBank[prev_char]);
      printf("%s     ", flag);
      printf("Flag End: %i\n", flag_end);
    }
    
    if(flag[3] != 'g' || flag[4] == '7'){
      printf("Flag not found");
      break;
    }
  }

  printf("Key gen Complete: ");
  printf("%s\n ", flag);
}







